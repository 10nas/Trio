var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(e/18,1):Math.round(e)}var i="",s="",l="",m="",u="",d="",c="",g="",b="";function f(e,r){var a=[2,7,12,16,20,50,60,80,90,100,110,150,180,200],t=[0,0,.4,.7,.7,-.5,-.5,-.3,-.2,0,0,.5,.7,.7],o=a.length-1,n=a[0],i=t[0],s=a[o],l=t[o],m=1,u=1,d=1,c=n;if(n>e)m=(u=i)+((l=t[1])-u)/((s=a[1])-(d=n))*(e-d);else if(s<e)m=(u=i=t[o-1])+(l-u)/(s-(d=n=a[o-1]))*(e-d);else for(var g=0;g<=o;g++){if(i=t[g],(n=a[g])==e){m=i;break}if(n>e){m=u+(i-u)/(n-(d=c))*(e-d);break}u=i,c=n}return m*=e>100?r.higher_ISFrange_weight:e>40?r.lower_ISFrange_weight:r.delta_ISFrange_weight}function p(e,r,a){if(void 0===e.smb_delivery_ratio_bg_range||0===e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var t=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+t),t;var n=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+n),n;var i=t+(n-t)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(i,2)),i}e.exports=function(e,r,a,h,v,_,B,M,x,y){var S="",C="",F="";if(void 0!==v&&v){const r=v.ratio,a=h.curve,t=h.insulinPeakTime,n=h.useCustomPeakTime,i=h.autoseens_min,s=h.autosens_max,l=h.adjustmentFactor,m=h.enableChris,u=h.enableDynamicCR;var I=55,w=e.glucose;switch(a){case"rapid-acting":I=55;break;case"ultra-rapid":I=t<75&&1==n?120-t:70}1!=m&&1!=u||(1==h.useNewFormula?(tddformula=", Formula: Logarithmic, AF: "+l,F=", TDD: "+o(1800*r/(h.sens*l*Math.log(w/I+1)),2)+" U"):(C=", Formula: Original, AF: "+l,F=", TDD: "+o(277700*r/(h.sens*l*w),2)+" U"),r!=i&&r!=s||(console.error("tdd: N/A"),0,F=", TDD: N/A"),S=F+C)}var G={},O=new Date;if(y&&(O=y),void 0===h||void 0===h.current_basal)return G.error="Error: could not get current basal rate",G;var T=t(h.current_basal,h),A=T,D=new Date;y&&(D=y);var R,U=new Date(e.date),j=o((D-U)/60/1e3,1),P=e.glucose,k=e.noise;R=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var q=Math.min(e.delta,e.short_avgdelta),E=Math.min(e.short_avgdelta,e.long_avgdelta),W=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(P<=10||38===P||k>=3)&&(G.reason="CGM is calibrating, in ??? state, or noise is high");if(P>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&("fakecgm"==e.device?(console.error("CGM data is unchanged ("+n(P,h)+"+"+n(e.delta,h)+") for 5m w/ "+n(e.short_avgdelta,h)+" mg/dL ~15m change & "+n(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")):!0),j>12||j<-5?G.reason="If current system time "+D+" is correct, then BG data is too old. The last BG data was read "+j+"m ago at "+U:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?G.reason="CGM was just calibrated":G.reason="CGM data is unchanged ("+n(P,h)+"+"+n(e.delta,h)+") for 5m w/ "+n(e.short_avgdelta,h)+" mg/dL ~15m change & "+n(e.long_avgdelta,h)+" mg/dL ~45m change"),P<=10||38===P||k>=3||j>12||j<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=A?(G.reason+=". Canceling high temp basal of "+r.rate,G.deliverAt=O,G.temp="absolute",G.duration=0,G.rate=0,G):0===r.rate&&r.duration>30?(G.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",G.deliverAt=O,G.temp="absolute",G.duration=30,G.rate=0,G):(G.reason+=". Temp "+r.rate+" <= current basal "+A+"U/hr; doing nothing. ",G);var z,L,N,Z=h.max_iob;if(void 0!==h.min_bg&&(L=h.min_bg),void 0!==h.max_bg&&(N=h.max_bg),void 0===h.min_bg||void 0===h.max_bg)return G.error="Error: could not determine target_bg. ",G;z=(h.min_bg+h.max_bg)/2;var $=h.exercise_mode||h.high_temptarget_raises_sensitivity,H=100,J=160;if(h.half_basal_exercise_target&&(J=h.half_basal_exercise_target),$&&h.temptargetSet&&z>H||h.low_temptarget_lowers_sensitivity&&h.temptargetSet&&z<H){var K=J-H;K+z-H>0?(sensitivityRatio=K/(K+z-H),sensitivityRatio=Math.min(sensitivityRatio,h.autosens_max),sensitivityRatio=o(sensitivityRatio,2)):sensitivityRatio=h.autosens_max,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+z+"; ")}else void 0!==v&&v&&(sensitivityRatio=v.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(A=h.current_basal*sensitivityRatio,(A=t(A,h))!==T?process.stderr.write("Adjusting basal from "+T+" to "+A+"; "):process.stderr.write("Basal unchanged: "+A+"; ")),h.temptargetSet);else if(void 0!==v&&v&&(h.sensitivity_raises_target&&v.ratio<1||h.resistance_lowers_target&&v.ratio>1)){L=o((L-60)/v.ratio)+60,N=o((N-60)/v.ratio)+60;var Q=o((z-60)/v.ratio)+60;z===(Q=Math.max(80,Q))?process.stderr.write("target_bg unchanged: "+Q+"; "):process.stderr.write("target_bg from "+z+" to "+Q+"; "),z=Q}var V=200,X=200,Y=200;if(e.noise>=2){var ee=Math.max(1.1,h.noisyCGMTargetMultiplier);Math.min(250,h.maxRaw);V=o(Math.min(200,L*ee)),X=o(Math.min(200,z*ee)),Y=o(Math.min(200,N*ee)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+z+" to "+X+"; "),L=V,z=X,N=Y}var re=L-.5*(L-40),ae=o(h.sens,1),te=h.sens;if(void 0!==v&&v&&((te=o(te=h.sens/sensitivityRatio,1))!==ae?process.stderr.write("ISF from "+n(ae,h)+" to "+n(te,h)):process.stderr.write("ISF unchanged: "+n(te,h)),i+="Autosens ratio: "+o(sensitivityRatio,2)+", ISF: "+n(ae,h)+"→"+n(te,h)),console.error("CR:"+h.carb_ratio),te=function(e,r,a,t,h,v,_,B){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),e;var M=t.dura_p,x=t.delta_pl,y=t.delta_pn,S=t.r_squ,C=t.bg_acceleration,F=t.parabola_fit_a0,I=t.parabola_fit_a1,w=t.parabola_fit_a2,G=t.autoISF_duration,O=t.autoISF_average,T=a.autoisf_max,A=!1,D=1,R=1,U=1,j=r+10-O;if(!(h.mealCOB>0)||a.enableautoisf_with_COB){var P=t.pp_debug;if(d+="BG-accel: "+o(C,3)+", PF-minutes: "+M+", PF-corr: "+o(S,4)+", PF-nextDelta: "+n(y,a)+", PF-lastDelta: "+n(x,a)+", regular Delta: "+n(t.delta,a),console.error(P+d+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var k=C;if(0!=t.parabola_fit_a2){var q=-I/2/w*5,E=o(F-q*q/25*w,1);(q=o(q,1))<0&&k<0?(b="saw max of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+b)):q<0&&k>0?(b="saw min of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+b)):q>0&&k<0?(b="predicts max of "+n(E,a)+", in about "+q+"min",console.error("Parabolic fit "+b)):q>0&&k>0&&(b="predicts min of "+n(E,a)+", in about "+q+" min",console.error("Parabolic fit "+b))}var W=S;if(W<=.9)b="acce_ISF by-passed, as correlation, "+o(W,3)+", is too low",console.error("Parabolic fit "+b),c+=", Parabolic Fit, "+b;else{c+=", Parabolic Fit, "+b+", lastΔ: "+n(x,a)+", nextΔ: "+n(y,a)+", Corr "+o(S,3)+", BG-Accel: "+o(k,2);var z=10*(W-.9),L=1;t.glucose<a.target_bg&&k>1&&(L=.5),U=1+k*L*(k<0?a.bgBrake_ISF_weight:a.bgAccel_ISF_weight)*z,console.error("Original result for acce_ISF: "+o(U,2)),1!=U&&(A=!0,c+=", acce-ISF Ratio: "+o(U,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");var N=p(a,t.glucose,r);i+=", SMB Delivery Ratio:, "+o(N,2)+c+", autoISF";var Z=1+f(100-j,a);console.error("bg_ISF adaptation is "+o(Z,2)),Z<1&&U>1&&(g="bg-ISF adaptation lifted to "+o(Z*=U,2)+", as BG accelerates already",s="(lifted by "+o(U,2)+")",console.error(g));var $=1;if(Z<1)return($=Math.min(Z,U))<a.autoisf_min&&(g="final ISF factor "+o($,2)+" limited by autoisf_min "+a.autoisf_min,console.error(g),$=a.autoisf_min),s=" (lmtd.)",earlysens=Math.min(720,o(a.sens/Math.min(B,$),1)),console.error("early Return autoISF:  "+n(earlysens,a)),i+=", bg-ISF Ratio: "+o(Z,2)+s+", ISF: "+n(earlysens,a),earlysens;Z>1&&(A=!0,i+=", bg-ISF Ratio: "+o(Z,2));var H=t.delta;j>0?console.error("delta_ISF adaptation by-passed as average glucose < "+n(r+10,a)):t.short_avgdelta<0?console.error("delta_ISF adaptation by-passed as no rise or too short lived"):a.enableppisf_always||a.postmeal_ISF_duration>=(v-h.lastCarbTime)/1e3/3600?(D=1+Math.max(0,H*a.postmeal_ISF_weight),console.error("pp_ISF adaptation is "+o(D,2)),m=", pp-ISF Ratio: "+o(D,2),1!=D&&(A=!0)):(R=f(H,a),j>-20&&(R*=.5),R=1+R,console.error("delta_ISF adaptation is "+o(R,2)),u=", Δ-ISF Ratio: "+o(R,2),1!=R&&(A=!0));var J=1,K=a.autoisf_hourlychange;return h.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1)):G<10?console.error("dura_ISF by-passed; BG is only "+G+"m at level "+O):O<=r?console.error("dura_ISF by-passed; avg. glucose "+O+" below target "+n(r,a)):(J+=G/60*(K/r)*(O-r),A=!0,l=", Duration: "+G+", Avg: "+n(O,a)+", dura-ISF Ratio: "+o(J,2),console.error("dura_ISF  adaptation is "+o(J,2)+" because ISF "+e+" did not do it for "+o(G,1)+"m")),$=1,A?($=Math.max(J,Z,R,U,D),console.error("autoISF adaption ratios:"),console.error("  dura "+o(J,2)),console.error("  bg "+o(Z,2)),console.error("  delta "+o(R,2)),console.error("  pp "+o(D,2)),console.error("  accel "+o(U,2)),U<1&&(console.error("strongest ISF factor "+o($,2)+" weakened to "+o($*U,2)+" as bg decelerates already"),$*=U),$<a.autoisf_min?(console.error("final ISF factor "+o($,2)+" limited by autoisf_min "+a.autoisf_min),$=a.autoisf_min):$>T&&(console.error("final ISF factor "+o($,2)+" limited by autoisf_max "+T),$=T),$>=1&&(e=o(a.sens/Math.max($,B),1)),$<1&&(e=o(a.sens/Math.min($,B),1))):$=B,i+=m+u+l+", Ratio: "+o($,2)+", ISF: "+n(e,a),console.error("Inside autoISF: Ratio "+o($,2)+" resulting in "+n(e,a)),e}console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(h.mealCOB,1))}(te,z,h,e,_,y,0,sensitivityRatio),void 0===a)return G.error="Error: iob_data undefined. ",G;var oe,ne=a;if(a.length,a.length>1&&(a=ne[0]),void 0===a.activity||void 0===a.iob)return G.error="Error: iob_data missing some property. ",G;var ie=((oe=void 0!==a.lastTemp?o((new Date(D).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+oe+"m, tempModulus:"+ie+"m"),G.temp="absolute",G.deliverAt=O,M&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&oe>10&&r.duration)return G.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",B.setTempBasal(0,0,h,G,r);if(r&&a.lastTemp&&r.duration>0){var se=oe-a.lastTemp.duration;if(se>5&&oe>10)return G.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+se+"m ago; canceling temp",B.setTempBasal(0,0,h,G,r)}var le=o(-a.activity*te*5,2),me=o(6*(q-le));me<0&&(me=o(6*(E-le)))<0&&(me=o(6*(e.long_avgdelta-le)));var ue=P,de=(ue=a.iob>0?o(P-a.iob*te):o(P-a.iob*Math.min(te,h.sens)))+me;if(void 0===de||isNaN(de))return G.error="Error: could not calculate eventualBG. Sensitivity: "+te+" Deviation: "+me,G;var ce=function(e,r,a){return o(a+(e-r)/24,1)}(z,de,le);G={temp:"absolute",bg:P,tick:R,eventualBG:de,insulinReq:0,reservoir:x,deliverAt:O,sensitivityRatio};var ge=[],be=[],fe=[],pe=[];ge.push(P),be.push(P),pe.push(P),fe.push(P);var he=function(e,r,a,t){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&t>100?(console.error("SMB disabled due to high temptarget of",t),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&t<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(t,e)),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(h,M,_,z),ve=h.enableUAM,_e=0,Be=0;_e=o(q-le,1);var Me=o(q-le,1);csf=te/h.carb_ratio,console.error("profile.sens:"+n(h.sens,h)+", sens:"+n(te,h)+", CSF:"+o(csf,1));var xe=o(30*csf*5/60,1);_e>xe&&(console.error("Limiting carb impact from "+_e+" to "+xe+"mg/dL/5m (30g/h)"),_e=xe);var ye=3;sensitivityRatio&&(ye/=sensitivityRatio);var Se=ye;if(_.carbs){ye=Math.max(ye,_.mealCOB/20);var Ce=o((new Date(D).getTime()-_.lastCarbTime)/6e4),Fe=(_.carbs-_.mealCOB)/_.carbs;Se=o(Se=ye+1.5*Ce/60,1),console.error("Last carbs "+Ce+" minutes ago; remainingCATime:"+Se+"hours; "+o(100*Fe)+"% carbs absorbed")}var Ie=Math.max(0,_e/5*60*Se/2)/csf,we=90,Ge=1;h.remainingCarbsCap&&(we=Math.min(90,h.remainingCarbsCap)),h.remainingCarbsFraction&&(Ge=Math.min(1,h.remainingCarbsFraction));var Oe=1-Ge,Te=Math.max(0,_.mealCOB-Ie-_.carbs*Oe),Ae=(Te=Math.min(we,Te))*csf*5/60/(Se/2),De=o(_.slopeFromMaxDeviation,2),Re=o(_.slopeFromMinDeviation,2),Ue=Math.min(De,-Re/3),je=0;0===_e?Be=0:!0===h.floating_carbs?(Be=Math.min(60*Se/5/2,Math.max(0,_.carbs*csf/_e)),je=Math.min(60*Se/5/2,Math.max(0,_.mealCOB*csf/_e)),_.carbs>0&&(i+=", Floating Carbs:, CID: "+o(Be,1)+", MealCarbs: "+o(_.carbs,1)+", Not Floating:, CID: "+o(je,1)+", MealCOB: "+o(_.mealCOB,1),console.error("Floating Carbs CID: "+o(Be,1)+" / MealCarbs: "+o(_.carbs,1)+" vs. Not Floating:"+o(je,1)+" / MealCOB:"+o(_.mealCOB,1)))):Be=Math.min(60*Se/5/2,Math.max(0,_.mealCOB*csf/_e)),console.error("Carb Impact:"+_e+"mg/dL per 5m; CI Duration:"+o(5*Be/60*2,1)+"hours; remaining CI ("+Se/2+"h peak):",o(Ae,1)+"mg/dL per 5m");var Pe,ke,qe,Ee,We,ze=999,Le=999,Ne=999,Ze=P,$e=999,He=999,Je=999,Ke=999,Qe=de,Ve=P,Xe=P,Ye=0,er=[],rr=[];try{ne.forEach((function(e){var r=o(-e.activity*te*5,2),a=o(-e.iobWithZeroTemp.activity*te*5,2),t=_e*(1-Math.min(1,be.length/12));Qe=be[be.length-1]+r+t;var n=pe[pe.length-1]+a,i=Math.max(0,Math.max(0,_e)*(1-ge.length/Math.max(2*Be,1))),s=Math.min(ge.length,12*Se-ge.length),l=Math.max(0,s/(Se/2*12)*Ae);i+l,er.push(o(l,0)),rr.push(o(i,0)),COBpredBG=ge[ge.length-1]+r+Math.min(0,t)+i+l;var m=Math.max(0,Me+fe.length*Ue),u=Math.max(0,Me*(1-fe.length/Math.max(36,1))),d=Math.min(m,u);d>0&&(Ye=o(5*(fe.length+1)/60,1)),UAMpredBG=fe[fe.length-1]+r+Math.min(0,t)+d,be.length<48&&be.push(Qe),ge.length<48&&ge.push(COBpredBG),fe.length<48&&fe.push(UAMpredBG),pe.length<48&&pe.push(n),COBpredBG<$e&&($e=o(COBpredBG)),UAMpredBG<He&&(He=o(UAMpredBG)),Qe<Je&&(Je=o(Qe)),n<Ke&&(Ke=o(n));be.length>18&&Qe<ze&&(ze=o(Qe)),Qe>Ve&&(Ve=Qe),(Be||Ae>0)&&ge.length>18&&COBpredBG<Le&&(Le=o(COBpredBG)),(Be||Ae>0)&&COBpredBG>Ve&&(Xe=COBpredBG),ve&&fe.length>12&&UAMpredBG<Ne&&(Ne=o(UAMpredBG)),ve&&UAMpredBG>Ve&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}_.mealCOB&&(console.error("predCIs (mg/dL/5m):"+rr.join(" ")),console.error("remainingCIs:      "+er.join(" "))),G.predBGs={},be.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var ar=be.length-1;ar>12&&be[ar-1]===be[ar];ar--)be.pop();for(G.predBGs.IOB=be,qe=o(be[be.length-1]),pe.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ar=pe.length-1;ar>6&&!(pe[ar-1]>=pe[ar]||pe[ar]<=z);ar--)pe.pop();if(G.predBGs.ZT=pe,o(pe[pe.length-1]),_.mealCOB>0&&(_e>0||Ae>0)){for(ge.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ar=ge.length-1;ar>12&&ge[ar-1]===ge[ar];ar--)ge.pop();G.predBGs.COB=ge,Ee=o(ge[ge.length-1]),de=Math.max(de,o(ge[ge.length-1]))}if(_e>0||Ae>0){if(ve){for(fe.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),ar=fe.length-1;ar>12&&fe[ar-1]===fe[ar];ar--)fe.pop();G.predBGs.UAM=fe,We=o(fe[fe.length-1]),fe[fe.length-1]&&(de=Math.max(de,o(fe[fe.length-1])))}G.eventualBG=de}console.error("UAM Impact:"+Me+"mg/dL per 5m; UAM Duration:"+Ye+"hours"),ze=Math.max(39,ze),Le=Math.max(39,Le),Ne=Math.max(39,Ne),Pe=o(ze);var tr=_.mealCOB/_.carbs;ke=o(Ne<999&&Le<999?(1-tr)*UAMpredBG+tr*COBpredBG:Le<999?(Qe+COBpredBG)/2:Ne<999?(Qe+UAMpredBG)/2:Qe),Ke>ke&&(ke=Ke),Ze=o(Ze=Be||Ae>0?ve?tr*$e+(1-tr)*He:$e:ve?He:Je);var or=Ne;if(Ke<re)or=(Ne+Ke)/2;else if(Ke<z){var nr=(Ke-re)/(z-re);or=(Ne+(Ne*nr+Ke*(1-nr)))/2}else Ke>Ne&&(or=(Ne+Ke)/2);if(or=o(or),_.carbs)if(!ve&&Le<999)Pe=o(Math.max(ze,Le));else if(Le<999){var ir=tr*Le+(1-tr)*or;Pe=o(Math.max(ze,Le,ir))}else Pe=ve?or:Ze;else ve&&(Pe=o(Math.max(ze,or)));Pe=Math.min(Pe,ke),process.stderr.write("minPredBG: "+Pe+" minIOBPredBG: "+ze+" minZTGuardBG: "+Ke),Le<999&&process.stderr.write(" minCOBPredBG: "+Le),Ne<999&&process.stderr.write(" minUAMPredBG: "+Ne),console.error(" avgPredBG:"+ke+" COB/Carbs:"+_.mealCOB+"/"+_.carbs),Xe>P&&(Pe=Math.min(Pe,Xe)),G.COB=_.mealCOB,G.IOB=a.iob,G.BGI=n(le,h),G.deviation=n(me,h),G.ISF=n(te,h),G.CR=o(h.carb_ratio,2),G.target_bg=n(z,h),G.reason=i+", COB: "+G.COB+", Dev: "+G.deviation+", BGI: "+G.BGI+", CR: "+G.CR+", Target: "+G.target_bg+", minPredBG "+n(Pe,h)+", minGuardBG "+n(Ze,h)+", IOBpredBG "+n(qe,h)+S,Ee>0&&(G.reason+=", COBpredBG "+n(Ee,h)),We>0&&(G.reason+=", UAMpredBG "+n(We,h)),G.reason+="; ";var sr=ue;sr<40&&(sr=Math.min(Ze,sr));var lr,mr=re-sr,ur=240,dr=240;if(_.mealCOB>0&&(_e>0||Ae>0)){for(ar=0;ar<ge.length;ar++)if(ge[ar]<L){ur=5*ar;break}for(ar=0;ar<ge.length;ar++)if(ge[ar]<re){dr=5*ar;break}}else{for(ar=0;ar<be.length;ar++)if(be[ar]<L){ur=5*ar;break}for(ar=0;ar<be.length;ar++)if(be[ar]<re){dr=5*ar;break}}he&&Ze<re&&(console.error("minGuardBG "+n(Ze,h)+" projected below "+n(re,h)+" - disabling SMB"),he=!1),void 0===h.maxDelta_bg_threshold&&(lr=.2),void 0!==h.maxDelta_bg_threshold&&(lr=Math.min(h.maxDelta_bg_threshold,.4)),W>lr*P&&(console.error("maxDelta "+n(W,h)+" > "+100*lr+"% of BG "+n(P,h)+" - disabling SMB"),G.reason+="maxDelta "+n(W,h)+" > "+100*lr+"% of BG "+n(P,h)+" - SMB disabled!, ",he=!1),console.error("BG projected to remain above "+n(L,h)+" for "+ur+"minutes"),(dr<240||ur<60)&&console.error("BG projected to remain above "+n(re,h)+" for "+dr+"minutes");var cr=dr,gr=h.current_basal*te*cr/60,br=Math.max(0,_.mealCOB-.25*_.carbs),fr=(mr-gr)/csf-br;gr=o(gr),fr=o(fr),console.error("naive_eventualBG:"+ue+" bgUndershoot:"+mr+" zeroTempDuration:"+cr+" zeroTempEffect:"+gr+" carbsReq:"+fr),fr>=h.carbsReqThreshold&&dr<=45&&(G.carbsReq=fr,G.reason+=fr+" add'l carbs req w/in "+dr+"m; ");var pr=0;if(P<re&&a.iob<20*-h.current_basal/60&&q>0&&q>ce)G.reason+="IOB "+a.iob+" < "+o(20*-h.current_basal/60,2),G.reason+=" and minDelta "+n(q,h)+" > expectedDelta "+n(ce,h)+"; ";else if(P<re||Ze<re)return G.reason+="minGuardBG "+n(Ze,h)+"<"+n(re,h),pr=o(60*((mr=z-Ze)/te)/h.current_basal),pr=30*o(pr/30),pr=Math.min(120,Math.max(30,pr)),B.setTempBasal(0,pr,h,G,r);if(h.skip_neutral_temps&&G.deliverAt.getMinutes()>=55)return G.reason+="; Canceling temp at "+G.deliverAt.getMinutes()+"m past the hour. ",B.setTempBasal(0,0,h,G,r);var hr=0,vr=A;if(de<L){if(G.reason+="Eventual BG "+n(de,h)+" < "+n(L,h),q>ce&&q>0&&!fr)return ue<40?(G.reason+=", naive_eventualBG < 40. ",B.setTempBasal(0,30,h,G,r)):(e.delta>q?G.reason+=", but Delta "+n(R,h)+" > expectedDelta "+n(ce,h):G.reason+=", but Min. Delta "+q.toFixed(2)+" > Exp. Delta "+n(ce,h),r.duration>15&&t(A,h)===t(r.rate,h)?(G.reason+=", temp "+r.rate+" ~ req "+A+"U/hr. ",G):(G.reason+="; setting current basal of "+A+" as temp. ",B.setTempBasal(A,30,h,G,r)));hr=o(hr=2*Math.min(0,(de-z)/te),2);var _r=Math.min(0,(ue-z)/te);if(_r=o(_r,2),q<0&&q>ce)hr=o(hr*(q/ce),2);if(vr=t(vr=A+2*hr,h),r.duration*(r.rate-A)/60<Math.min(hr,_r)-.3*A)return G.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",B.setTempBasal(vr,30,h,G,r);if(void 0!==r.rate&&r.duration>5&&vr>=.8*r.rate)return G.reason+=", temp "+r.rate+" ~< req "+vr+"U/hr. ",G;if(vr<=0){if((pr=o(60*((mr=z-ue)/te)/h.current_basal))<0?pr=0:(pr=30*o(pr/30),pr=Math.min(120,Math.max(0,pr))),pr>0)return G.reason+=", setting "+pr+"m zero temp. ",B.setTempBasal(vr,pr,h,G,r)}else G.reason+=", setting "+vr+"U/hr. ";return B.setTempBasal(vr,30,h,G,r)}if(q<ce&&(!M||!he))return e.delta<q?G.reason+="Eventual BG "+n(de,h)+" > "+n(L,h)+" but Delta "+n(R,h)+" < Exp. Delta "+n(ce,h):G.reason+="Eventual BG "+n(de,h)+" > "+n(L,h)+" but Min. Delta "+q.toFixed(2)+" < Exp. Delta "+n(ce,h),r.duration>15&&t(A,h)===t(r.rate,h)?(G.reason+=", temp "+r.rate+" ~ req "+A+"U/hr. ",G):(G.reason+="; setting current basal of "+A+" as temp. ",B.setTempBasal(A,30,h,G,r));if(Math.min(de,Pe)<N&&(!M||!he))return G.reason+=n(de,h)+"-"+n(Pe,h)+" in range: no temp required",r.duration>15&&t(A,h)===t(r.rate,h)?(G.reason+=", temp "+r.rate+" ~ req "+A+"U/hr. ",G):(G.reason+="; setting current basal of "+A+" as temp. ",B.setTempBasal(A,30,h,G,r));if(de>=N&&(G.reason+="Eventual BG "+n(de,h)+" >= "+n(N,h)+", "),a.iob>Z)return G.reason+="IOB "+o(a.iob,2)+" > max_iob "+Z,r.duration>15&&t(A,h)===t(r.rate,h)?(G.reason+=", temp "+r.rate+" ~ req "+A+"U/hr. ",G):(G.reason+="; setting current basal of "+A+" as temp. ",B.setTempBasal(A,30,h,G,r));(hr=o((Math.min(Pe,de)-z)/te,2))>Z-a.iob&&(G.reason+="max_iob "+Z+", ",hr=Z-a.iob),vr=t(vr=A+2*hr,h),hr=o(hr,3),G.insulinReq=hr;var Br=o((new Date(D).getTime()-a.lastBolusTime)/6e4,1);if(M&&he&&P>re){var Mr=o(_.mealCOB/h.carb_ratio,3);if(h.use_autoisf)xr=h.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var xr=1}xr>1&&console.error("SMB max range extended from default by factor "+xr);var yr=0;void 0===h.maxSMBBasalMinutes?(yr=o(xr*h.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>Mr&&a.iob>0?(console.error("IOB",a.iob,"> COB",_.mealCOB+"; mealInsulinReq =",Mr),h.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",h.maxUAMSMBBasalMinutes,"profile.current_basal:",h.current_basal),yr=o(xr*h.current_basal*h.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),yr=o(30*h.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",h.maxSMBBasalMinutes,"profile.current_basal:",h.current_basal),yr=o(xr*h.current_basal*h.maxSMBBasalMinutes/60,1));var Sr=h.bolus_increment,Cr=1/Sr;if(h.use_autoisf)var Fr=p(h,P,z);else console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Fr=.5;Fr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Fr,2));var Ir=Math.min(hr*Fr,yr);Ir=Math.floor(Ir*Cr)/Cr,pr=o(60*((z-(ue+ze)/2)/te)/h.current_basal),hr>0&&Ir<Sr&&(pr=0);var wr=0;pr<=0?pr=0:pr>=30?(pr=30*o(pr/30),pr=Math.min(60,Math.max(0,pr))):(wr=o(A*pr/30,2),pr=30),G.reason+=" insulinReq "+hr,Ir>=yr&&(G.reason+="; maxBolus "+yr),pr>0&&(G.reason+="; setting "+pr+"m low temp of "+wr+"U/h"),G.reason+=". ";var Gr=3;h.SMBInterval&&(Gr=Math.min(10,Math.max(1,h.SMBInterval)));var Or=o(Gr-Br,0),Tr=o(60*(Gr-Br),0)%60;if(console.error("naive_eventualBG",ue+",",pr+"m "+wr+"U/h temp needed; last bolus",Br+"m ago; maxBolus: "+yr),Br>Gr?Ir>0&&(G.units=Ir,G.reason+="Microbolusing "+Ir+"U. "):G.reason+="Waiting "+Or+"m "+Tr+"s to microbolus again. ",pr>0)return G.rate=wr,G.duration=pr,G}var Ar=B.getMaxSafeBasal(h);return vr>Ar&&(G.reason+="adj. req. rate: "+vr+" to maxSafeBasal: "+Ar+", ",vr=t(Ar,h)),r.duration*(r.rate-A)/60>=2*hr?(G.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+vr+"U/hr. ",B.setTempBasal(vr,30,h,G,r)):void 0===r.duration||0===r.duration?(G.reason+="no temp, setting "+vr+"U/hr. ",B.setTempBasal(vr,30,h,G,r)):r.duration>5&&t(vr,h)<=t(r.rate,h)?(G.reason+="temp "+r.rate+" >~ req "+vr+"U/hr. ",G):(G.reason+="temp "+r.rate+"<"+vr+"U/hr. ",B.setTempBasal(vr,30,h,G,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,m=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?m(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();